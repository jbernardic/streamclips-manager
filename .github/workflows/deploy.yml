name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        platforms: linux/arm64
        tags: ghcr.io/${{ github.repository }}:latest

    - name: Install hcloud CLI
      run: |
        wget -O hcloud.tar.gz https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz
        tar -xzf hcloud.tar.gz
        sudo mv hcloud /usr/local/bin/
        hcloud version
    
    - name: Get server IPs
      id: servers
      env:
        HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      run: |
        # Get all server IPs with app=instance label
        SERVER_IPS=$(hcloud server list -l app=instance -o noheader -o columns=public_ipv4 | tr '\n' ',' | sed 's/,$//')
        
        if [ -z "$SERVER_IPS" ]; then
          echo "No servers found with app=instance label"
          exit 1
        fi
        
        echo "Found servers: $SERVER_IPS"
        echo "ips=$SERVER_IPS" >> $GITHUB_OUTPUT
    
    - name: Deploy to Hetzner servers
      uses: carlosflorencio/hetzner_deployer@v1
      with:
        servers: ${{ steps.servers.outputs.ips }}
        hetzner_token: ${{ secrets.HCLOUD_TOKEN }}
        ssh_key: ${{ secrets.SSH_KEY }}
        ssh_port: 22
        graceful_wait_seconds: 5
        commands: |
          docker rm -f socialagents || true
          docker run -d --restart always \
            --name socialagents \
            -p 8000:8000 \
            -v socialagents_data:/app/data \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            -e ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}" \
            -e STORAGE_SERVER_HOST="${{ secrets.STORAGE_SERVER_HOST }}" \
            -e STORAGE_SERVER_USER="${{ secrets.STORAGE_SERVER_USER }}" \
            -e STORAGE_SERVER_PASSWORD="${{ secrets.STORAGE_SERVER_PASSWORD }}" \
            -e STORAGE_SERVER_PATH="${{ vars.STORAGE_SERVER_PATH }}" \
            -e INSTANCE_MAX_PROCESSES="${{ vars.INSTANCE_MAX_PROCESSES }}" \
            ghcr.io/${{ github.repository }}:latest